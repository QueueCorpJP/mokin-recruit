# ==============================================================================
# Development Dockerfile for Next.js 15 + Supabase Application (pnpmå¯¾å¿œ)
# MVPã‚¹ã‚­ãƒ¼ãƒå¯¾å¿œ + pnpmãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æœ€é©åŒ–
# ==============================================================================

FROM node:20-alpine

# Install system dependencies for network connectivity and SSL
RUN apk update && apk upgrade && apk add --no-cache \
    ca-certificates \
    curl \
    wget \
    bind-tools \
    jq \
    && rm -rf /var/cache/apk/*

# Install pnpm globally
RUN npm install -g pnpm@latest

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
WORKDIR /app

# package.jsonã‚’ã‚³ãƒ”ãƒ¼ï¼ˆclientãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚‚ã®ï¼‰
COPY package.json ./

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pnpm install --no-frozen-lockfile

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV NODE_ENV=development
ENV PORT=3000
ENV NEXT_TELEMETRY_DISABLED=1
ENV HOSTNAME=0.0.0.0

# ãƒãƒ¼ãƒˆã‚’å…¬é–‹
EXPOSE 3000

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
RUN echo '#!/bin/sh\n\
echo "ğŸ” Health check starting..."\n\
if curl -f --max-time 10 http://localhost:3000/api/health; then\n\
  echo "âœ… Health check passed"\n\
  exit 0\n\
else\n\
  echo "âŒ Health check failed"\n\
  exit 1\n\
fi' > /usr/local/bin/healthcheck.sh && \
    chmod +x /usr/local/bin/healthcheck.sh

# æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
RUN echo '#!/bin/sh\n\
echo "ğŸŒ Testing network connectivity..."\n\
echo "----------------------------------------"\n\
\n\
# DNSè§£æ±ºãƒ†ã‚¹ãƒˆ\n\
echo "ğŸ“‹ DNS Resolution Test:"\n\
if nslookup mjhqeagxibsklugikyma.supabase.co; then\n\
  echo "âœ… DNS resolution successful"\n\
else\n\
  echo "âŒ DNS resolution failed"\n\
fi\n\
\n\
# Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ\n\
echo "ğŸ”— Supabase Connection Test:"\n\
if curl -I --max-time 10 https://mjhqeagxibsklugikyma.supabase.co/rest/v1/; then\n\
  echo "âœ… Supabase connection successful"\n\
else\n\
  echo "âŒ Supabase connection failed"\n\
fi\n\
\n\
# ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯\n\
echo "ğŸ”§ Environment Variables:"\n\
echo "SUPABASE_URL: ${SUPABASE_URL:-NOT_SET}"\n\
echo "NODE_ENV: ${NODE_ENV:-NOT_SET}"\n\
echo "PORT: ${PORT:-NOT_SET}"\n\
\n\
echo "----------------------------------------"\n\
echo "ğŸ¯ Connectivity test completed"' > /usr/local/bin/connectivity-test.sh && \
    chmod +x /usr/local/bin/connectivity-test.sh

# MVPã‚¹ã‚­ãƒ¼ãƒç¢ºèªç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
RUN echo '#!/bin/sh\n\
echo "ğŸ“Š MVP Schema Status Check..."\n\
echo "----------------------------------------"\n\
\n\
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ\n\
if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_ANON_KEY" ]; then\n\
  echo "ğŸ”— Testing MVP schema tables..."\n\
  \n\
  # å€™è£œè€…ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª\n\
  if curl -s --max-time 10 \\\n\
    -H "apikey: $SUPABASE_ANON_KEY" \\\n\
    -H "Authorization: Bearer $SUPABASE_ANON_KEY" \\\n\
    "$SUPABASE_URL/rest/v1/candidates?select=id&limit=1" > /dev/null; then\n\
    echo "âœ… Candidates table accessible"\n\
  else\n\
    echo "âŒ Candidates table not accessible"\n\
  fi\n\
  \n\
  # ä¼æ¥­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª\n\
  if curl -s --max-time 10 \\\n\
    -H "apikey: $SUPABASE_ANON_KEY" \\\n\
    -H "Authorization: Bearer $SUPABASE_ANON_KEY" \\\n\
    "$SUPABASE_URL/rest/v1/company_accounts?select=id&limit=1" > /dev/null; then\n\
    echo "âœ… Company accounts table accessible"\n\
  else\n\
    echo "âŒ Company accounts table not accessible"\n\
  fi\n\
else\n\
  echo "âŒ Supabase environment variables not set"\n\
fi\n\
\n\
echo "----------------------------------------"\n\
echo "ğŸ¯ MVP Schema check completed"' > /usr/local/bin/mvp-schema-check.sh && \
    chmod +x /usr/local/bin/mvp-schema-check.sh

# pnpmé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
CMD ["pnpm", "run", "dev"] 