# Company リファクタリング拡張版 概要

本ドキュメントは、`src/app/company` 配下のリファクタリングについて、背景・目的・非機能要件・適用範囲・アウトカムを包括的に示す概要です。UI/UX・ルーティング・文言・DOM・スタイルは一切変更せず、内部品質と運用性を段階的に改善します。

## 1. 背景

- ドメイン型やユーティリティの重複により、修正コスト・変更リスクが増大
- 認証/認可ロジック、メール送信、グループ取得などの共通処理が分散
- サーバーアクション入出力が非統一で、型安全性とテスト容易性が不足
- マスタデータの定義が重複し、変更追従に不整合が発生し得る

## 2. 目的（達成基準）

- 後方互換・UI非変更を厳守しつつ、以下を達成
  - 重複ロジック/マスタの単一ソース化（DRY）
  - サーバーアクションの型・バリデーション統一
  - 認証/認可・ログ・再検証(revalidate)の一元化
  - ドメイン型とUI型の明確な分離による可読性と保守性向上
  - 安全な段階的移行（小PR・ロールバック容易性）

## 3. 非機能要件（Quality Attributes）

- 可読性: ファイル責務の明確化、命名一貫性
- 保守性: 変更影響範囲の局所化、共通化の徹底
- 信頼性: 失敗時のFail-Safe、例外ハンドリング統一
- セキュリティ: RLS/認可の維持、権限マッピングの厳密化
- 運用性: ログ一元化、設定（Env）存在チェックの徹底

## 4. 適用範囲と非目標

- 範囲: `src/app/company/**` と、それに密接な `lib/**`, `constants/**`, `types/**`, `components/**` の新規ファイル追加
- 非目標: UI/UX、DOM、文言、URL、DBスキーマ、API仕様の変更

## 5. 成果物（新規追加の代表例）

- `types/company.ts`: Group/Member/JobPostingなどの中核型（ドメイン/表示用）
- `lib/company/permissions.ts`: 権限変換の単一実装
- `lib/company/groups.ts`: 企業グループ取得の共通実装（RLS前提）
- `lib/server/actions/{response,revalidate}.ts`: 成功/失敗型・revalidate集約
- `lib/server/mail/sendgrid.ts`: メール送信のフェイルセーフな共通実装
- `constants/prefectures.ts`: 都道府県の単一ソース
- `src/app/company/constants/routes.ts`: 認証保護ルートの単一ソース

## 6. マイルストンと検証

1) 追加のみの基盤導入 → 2) 依存少の参照切替 → 3) サーバーアクション統一 → 4) 重複ユーティリティ統一 → 5) モーダル共通化

各段で `pnpm build` と主要フローの手動確認を実施。差分が UI に現れないことを確認。

## 7. リスクと回避策

- 型集中化に伴う暫定的型エラー: ディレクトリ単位・小PRでの移行
- 認可の副作用: 既存条件の踏襲、共通関数は薄い委譲から開始
- メール送信の共通化: Env存在チェック、障害時はログのみで継続

---

次章: 詳細なフォルダリング/アーキテクチャ設計（01-architecture-and-foldering.md）


