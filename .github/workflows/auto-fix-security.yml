name: Auto-fix Security Issues

on:
  schedule:
    # æ¯Žæ—¥åˆå‰2æ™‚ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Type of fixes to apply'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - security
          - linting
          - formatting

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get CodeQL alerts
        id: get-alerts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: alerts } = await github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              severity: 'high,critical'
            });

            console.log(`Found ${alerts.length} high/critical alerts`);

            const securityAlerts = alerts.filter(alert =>
              alert.rule.security_severity_level === 'high' ||
              alert.rule.security_severity_level === 'critical'
            );

            core.setOutput('alerts', JSON.stringify(securityAlerts));
            core.setOutput('count', securityAlerts.length);

            return securityAlerts.length > 0;

      - name: Apply ESLint auto-fixes
        if: steps.get-alerts.outputs.count > 0 || github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'linting'
        run: |
          # ESLintã§ä¿®æ­£å¯èƒ½ãªå•é¡Œã‚’è‡ªå‹•ä¿®æ­£
          npm run lint -- --fix || true

          # TypeScriptåž‹ã‚¨ãƒ©ãƒ¼ã®ç°¡å˜ãªä¿®æ­£
          npm run type-check || true

      - name: Apply Prettier formatting
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'formatting'
        run: |
          # Prettierã§ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
          npm run format || npx prettier --write "src/**/*.{ts,tsx,js,jsx}" || true

      - name: Apply security fixes
        if: steps.get-alerts.outputs.count > 0 || github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'security'
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ä¸€èˆ¬çš„ãªä¿®æ­£

          # 1. ä¸è¦ãªconsole.logã®å‰Šé™¤ï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
          find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | \
            xargs sed -i '/console\.log/d' || true

          # 2. å±é™ºãªinnerHTMLã®ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯
          find src -name "*.tsx" | \
            xargs grep -l "dangerouslySetInnerHTML" | \
            head -5 | \
            while read file; do
              echo "âš ï¸  Found dangerouslySetInnerHTML in $file - manual review required"
            done || true

          # 3. HTTPSã®å¼·åˆ¶
          find src -name "*.ts" -o -name "*.tsx" | \
            xargs sed -i 's/http:\/\//https:\/\//g' || true

      - name: Check for dependency vulnerabilities
        run: |
          # npm auditã§è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¯èƒ½ãªã‚‚ã®ã¯è‡ªå‹•ä¿®æ­£
          npm audit --audit-level=high || true
          npm audit fix --force || true

      - name: Check if changes were made
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT
          echo "changed_files=$(git diff --name-only | wc -l)" >> $GITHUB_OUTPUT

      - name: Commit and create PR
        if: steps.git-check.outputs.changes == 'true'
        run: |
          # Gitã®è¨­å®š
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
          BRANCH_NAME="auto-fix/security-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME

          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add .
          git commit -m "ðŸ”’ Auto-fix security issues and code quality

          - Applied ESLint auto-fixes
          - Applied Prettier formatting
          - Fixed common security issues
          - Updated dependencies for security

          Generated by GitHub Actions
          Files changed: ${{ steps.git-check.outputs.changed_files }}"

          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin $BRANCH_NAME

          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
          gh pr create \
            --title "ðŸ”’ Auto-fix: Security and code quality improvements" \
            --body "## ðŸ¤– Automated Security Fixes

          This PR contains automated fixes for security issues and code quality improvements:

          ### Changes Made:
          - âœ… Applied ESLint auto-fixes
          - âœ… Applied Prettier formatting
          - âœ… Fixed common security issues
          - âœ… Updated dependencies for security

          ### Security Alerts Addressed:
          ${{ steps.get-alerts.outputs.count }} high/critical severity alerts found

          ### Files Changed:
          ${{ steps.git-check.outputs.changed_files }}

          **âš ï¸ Please review these changes carefully before merging.**

          ### Manual Review Required:
          - Check for any breaking changes
          - Verify that security fixes are appropriate
          - Test functionality in development environment

          ---
          *Generated automatically by GitHub Actions*" \
            --assignee "${{ github.actor }}" \
            --label "security,automated,needs-review"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ” Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Security alerts found**: ${{ steps.get-alerts.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files changed**: ${{ steps.git-check.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes made**: ${{ steps.git-check.outputs.changes == 'true' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.git-check.outputs.changes }}" == "true" ]; then
            echo "âœ… Created pull request with automated fixes" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
          fi