name: Deploy to AWS EC2 (code upload → EC2 build)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create source archive
        run: tar -czf source.tar.gz package.json package-lock.json next.config.js public src

      - name: Upload source to EC2
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          scp -i private_key.pem -o StrictHostKeyChecking=no \
            source.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          timeout: 30m
          command_timeout: 30m
          script: |
            set -euo pipefail
            echo "[INFO] Deploy start on $(hostname)"

            # Ensure nvm and Node.js 22.12.0 (vite requires ^20.19.0 || >=22.12.0)
            if [ ! -d "$HOME/.nvm" ]; then
              echo "[INFO] Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
            fi
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
            echo "[INFO] Installing Node 22.12.0..."
            nvm install 22.12.0
            nvm use 22.12.0
            node -v
            npm -v

            TARGET_DIR="/home/${{ secrets.EC2_USER }}/mokin-recruit"
            SOURCE_TARBALL="/home/${{ secrets.EC2_USER }}/source.tar.gz"

            # ディレクトリ準備
            mkdir -p "$TARGET_DIR"
            tar -xzf "$SOURCE_TARBALL" -C "$TARGET_DIR"
            rm -f "$SOURCE_TARBALL"

            cd "$TARGET_DIR"

            # .env.production を Secrets から生成
            cat > .env.production << 'EOF'
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            NODE_ENV=production
            EOF

            # 依存関係インストール & ビルド
            echo "[INFO] Installing dependencies..."
            npm ci --no-audit --no-fund --prefer-offline

            echo "[INFO] Building Next.js..."
            export NEXT_TELEMETRY_DISABLED=1
            NODE_OPTIONS='--max-old-space-size=4096' npm run build

            # pm2 で再起動
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi
            pm2 restart mokin-recruit || pm2 start npm --name mokin-recruit -- start

            echo "[INFO] Deploy completed!"
