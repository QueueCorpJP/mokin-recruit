name: Deploy to AWS EC2 (code upload â†’ EC2 build)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Debug Environment
        run: |
          echo "========================================="
          echo "ğŸ” ENVIRONMENT DIAGNOSTICS"
          echo "========================================="
          echo "ğŸ“… Current Date: $(date)"
          echo "ğŸƒ Runner: $RUNNER_NAME"
          echo "ğŸ–¥ï¸ Runner OS: $RUNNER_OS"
          echo "ğŸ“ Current Directory: $(pwd)"
          echo "ğŸ‘¤ Current User: $(whoami)"
          echo "ğŸ  Home Directory: $HOME"
          echo ""
          echo "ğŸ” GitHub Secrets Check (existence only):"
          echo "EC2_HOST: ${{ secrets.EC2_HOST != '' && 'âœ… Set' || 'âŒ Not Set' }}"
          echo "EC2_USER: ${{ secrets.EC2_USER != '' && 'âœ… Set' || 'âŒ Not Set' }}"
          echo "EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY != '' && 'âœ… Set' || 'âŒ Not Set' }}"
          echo "EC2_SSH_PRIVATE_KEY length: $(echo '${{ secrets.EC2_SSH_PRIVATE_KEY }}' | wc -c)"
          echo ""
          echo "ğŸŒ Network Diagnostics:"
          echo "Public IP: $(curl -s ifconfig.me || echo 'Failed to get IP')"
          echo ""
          echo "ğŸ“¦ Available Tools:"
          ssh -V 2>&1 || echo "SSH not found"
          scp 2>&1 | head -1 || echo "SCP not found"
          echo "========================================="

      - name: Create source archive
        run: |
          echo "ğŸ“¦ [STEP 1/3] Creating source archive..."
          echo "ğŸ” Files to include:"
          ls -la package.json package-lock.json next.config.js 2>/dev/null || echo "âš ï¸  Some base files missing"
          ls -la public/ src/ 2>/dev/null || echo "âš ï¸  Some directories missing"
          tar -czf source.tar.gz package.json package-lock.json next.config.js public src
          echo "âœ… Archive created: $(du -h source.tar.gz)"
          echo "ğŸ“Š Archive details:"
          tar -tzf source.tar.gz | head -20
          echo "... (showing first 20 files)"

      - name: Test EC2 Connectivity
        run: |
          echo "========================================="
          echo "ğŸ§ª TESTING EC2 CONNECTIVITY"
          echo "========================================="
          echo "ğŸ“¡ Testing DNS resolution for EC2_HOST..."
          nslookup ${{ secrets.EC2_HOST }} || echo "âš ï¸ DNS lookup failed"
          echo ""
          echo "ğŸ“ Testing ping to EC2_HOST (may fail due to ICMP blocking)..."
          ping -c 3 -W 2 ${{ secrets.EC2_HOST }} || echo "âš ï¸ Ping failed (might be normal)"
          echo ""
          echo "ğŸ”Œ Testing port 22 connectivity..."
          timeout 5 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.EC2_HOST }}/22" && echo "âœ… Port 22 is reachable" || echo "âŒ Port 22 is not reachable"
          echo ""
          echo "ğŸ” Testing with nc (if available)..."
          which nc && nc -zv -w5 ${{ secrets.EC2_HOST }} 22 || echo "nc not available or connection failed"
          echo "========================================="

      - name: Setup and Validate SSH Key
        run: |
          echo "========================================="
          echo "ğŸ”‘ SSH KEY SETUP AND VALIDATION"
          echo "========================================="
          echo "ğŸ“ Writing SSH key to file..."
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > queuepoint.pem
          chmod 600 queuepoint.pem

          echo "ğŸ” Key file details:"
          ls -la queuepoint.pem
          file queuepoint.pem

          echo ""
          echo "ğŸ” Key format check:"
          head -1 queuepoint.pem
          tail -1 queuepoint.pem

          echo ""
          echo "ğŸ“Š Key statistics:"
          echo "Lines: $(wc -l < queuepoint.pem)"
          echo "Characters: $(wc -c < queuepoint.pem)"
          echo "Words: $(wc -w < queuepoint.pem)"

          echo ""
          echo "ğŸ”§ SSH key validation:"
          ssh-keygen -y -e -f queuepoint.pem > /dev/null 2>&1 && echo "âœ… Key format is valid" || echo "âŒ Key format is invalid"

          echo ""
          echo "ğŸ“‹ SSH config setup:"
          mkdir -p ~/.ssh
          cat > ~/.ssh/config << EOF
          Host ec2-instance
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile $(pwd)/queuepoint.pem
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel DEBUG3
            ConnectTimeout 30
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          cat ~/.ssh/config
          echo "========================================="

      - name: Test SSH Connection with Verbose Logging
        continue-on-error: true
        run: |
          echo "========================================="
          echo "ğŸ”— TESTING SSH CONNECTION"
          echo "========================================="
          echo "ğŸ§ª Test 1: Basic SSH with verbose output"
          ssh -vvv -i queuepoint.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'âœ… SSH connection successful'" 2>&1 | tee ssh_test.log || {
            echo "âŒ SSH test failed with exit code: $?"
            echo ""
            echo "ğŸ“‹ Error Analysis:"
            grep -i "error\|fail\|refused\|denied\|timeout" ssh_test.log || echo "No specific errors found"
          }

          echo ""
          echo "ğŸ§ª Test 2: Using SSH config"
          ssh -vvv ec2-instance "echo 'âœ… SSH via config successful'" 2>&1 || echo "âŒ SSH via config failed"

          echo ""
          echo "ğŸ§ª Test 3: Alternative SSH command formats"
          timeout 10 ssh -i queuepoint.pem -o BatchMode=yes -o ConnectTimeout=5 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} exit 0 && echo "âœ… Batch mode SSH successful" || echo "âŒ Batch mode SSH failed"
          echo "========================================="

      - name: Upload source to EC2 with Enhanced Logging
        run: |
          echo "ğŸš€ [STEP 2/3] Uploading source to EC2..."
          echo "========================================="
          echo "ğŸ“¤ SCP UPLOAD WITH FULL DEBUG"
          echo "========================================="

          echo "ğŸ“Š Upload details:"
          echo "Source file: source.tar.gz ($(du -h source.tar.gz | cut -f1))"
          echo "Destination: ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/"
          echo ""

          echo "ğŸ”„ Starting SCP with maximum verbosity..."
          scp -vvv -i queuepoint.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=15 \
            -o ServerAliveCountMax=3 \
            -o TCPKeepAlive=yes \
            -o LogLevel=DEBUG3 \
            source.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/ 2>&1 | tee scp_upload.log || {
            EXIT_CODE=$?
            echo "âŒ SCP failed with exit code: $EXIT_CODE"
            echo ""
            echo "ğŸ“‹ SCP Error Analysis:"
            echo "Connection errors:"
            grep -i "connection\|connect" scp_upload.log | tail -10
            echo ""
            echo "Authentication errors:"
            grep -i "auth\|permission\|denied" scp_upload.log | tail -10
            echo ""
            echo "Timeout errors:"
            grep -i "timeout" scp_upload.log | tail -10
            echo ""
            echo "Other errors:"
            grep -i "error\|fail" scp_upload.log | tail -10
            echo ""
            echo "ğŸ” Last 50 lines of SCP log:"
            tail -50 scp_upload.log
            exit $EXIT_CODE
          }
          echo "âœ… Upload completed successfully"
          echo "========================================="

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          timeout: 30m
          command_timeout: 30m
          debug: true
          script: |
            set -euo pipefail
            echo "ğŸš€ [STEP 3/3] Starting deployment on $(hostname) at $(date)"

            # Ensure nvm and Node.js 22.12.0 (vite requires ^20.19.0 || >=22.12.0)
            echo "ğŸ“‹ [NODE] Checking Node.js environment..."
            if [ ! -d "$HOME/.nvm" ]; then
              echo "âš™ï¸  [NODE] Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
            fi
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
            echo "âš™ï¸  [NODE] Installing Node 22.12.0..."
            nvm install 22.12.0
            nvm use 22.12.0
            echo "âœ… [NODE] Node version: $(node -v)"
            echo "âœ… [NODE] npm version: $(npm -v)"

            TARGET_DIR="/home/${{ secrets.EC2_USER }}/mokin-recruit"
            SOURCE_TARBALL="/home/${{ secrets.EC2_USER }}/source.tar.gz"

            echo "ğŸ“ [FILES] Setting up directories..."
            echo "ğŸ“ [FILES] Target directory: $TARGET_DIR"
            echo "ğŸ“ [FILES] Source tarball: $SOURCE_TARBALL"

            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
            mkdir -p "$TARGET_DIR"
            echo "ğŸ“¦ [FILES] Extracting source archive..."
            tar -xzf "$SOURCE_TARBALL" -C "$TARGET_DIR"
            ls -la "$TARGET_DIR" || echo "âš ï¸  [FILES] Failed to list target directory"
            rm -f "$SOURCE_TARBALL"
            echo "âœ… [FILES] Source extraction completed"

            cd "$TARGET_DIR"
            echo "ğŸ“ [FILES] Current directory: $(pwd)"

            # .env.production ã‚’ Secrets ã‹ã‚‰ç”Ÿæˆ
            echo "âš™ï¸  [ENV] Creating environment file..."
            cat > .env.production << 'EOF'
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            NODE_ENV=production
            EOF
            echo "âœ… [ENV] Environment file created"

            # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« & ãƒ“ãƒ«ãƒ‰
            echo "ğŸ“¦ [NPM] Installing dependencies..."
            echo "ğŸ“¦ [NPM] Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
            echo "ğŸ“¦ [NPM] Package-lock.json exists: $(test -f package-lock.json && echo 'YES' || echo 'NO')"

            npm ci --no-audit --no-fund --prefer-offline || {
              echo "âŒ [NPM] Dependency installation failed with exit code $?"
              echo "ğŸ” [NPM] Debug info:"
              ls -la package*
              cat package.json | head -20
              exit 1
            }
            echo "âœ… [NPM] Dependencies installed successfully"

            echo "ğŸ—ï¸  [BUILD] Building Next.js application..."
            export NEXT_TELEMETRY_DISABLED=1
            NODE_OPTIONS='--max-old-space-size=4096' npm run build || {
              echo "âŒ [BUILD] Build failed with exit code $?"
              echo "ğŸ” [BUILD] Debug info:"
              ls -la .next/ 2>/dev/null || echo "No .next directory found"
              tail -50 ~/.npm/_logs/*.log 2>/dev/null || echo "No npm logs found"
              exit 1
            }
            echo "âœ… [BUILD] Build completed successfully"

            # pm2 ã§å†èµ·å‹•
            echo "ğŸ”„ [PM2] Managing PM2 process..."
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "âš™ï¸  [PM2] Installing PM2..."
              npm install -g pm2
            fi

            echo "ğŸ”„ [PM2] Restarting application..."
            pm2 restart mokin-recruit || pm2 start npm --name mokin-recruit -- start || {
              echo "âŒ [PM2] PM2 operation failed with exit code $?"
              pm2 list
              pm2 logs mokin-recruit --lines 50
              exit 1
            }
            echo "âœ… [PM2] Application restarted successfully"

            echo "ğŸ‰ [SUCCESS] Deploy completed at $(date)!"
            echo "ğŸ” [STATUS] Final PM2 status:"
            pm2 list
