name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Build application
        run: npm run build

      - name: Create deployment package
        run: |
          # standaloneãƒ“ãƒ«ãƒ‰ã®å ´åˆã®è¨­å®š
          mkdir -p deploy
          cp -r .next/standalone/* deploy/
          cp -r .next/static deploy/.next/static/
          cp -r public deploy/public/

          # package.jsonã‚’ã‚³ãƒ”ãƒ¼ (dependenciesæƒ…å ±ã®ãŸã‚)
          cp package.json deploy/

          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ğŸš€ Starting deployment..."

          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          APP_DIR="/home/ec2-user/mokin-recruit"

          # æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
          echo "Stopping existing application..."
          sudo pkill -f "node server.js" || true
          sleep 2

          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
          if [ -d "$APP_DIR" ]; then
            echo "Creating backup..."
            sudo mv "$APP_DIR" "$APP_DIR.backup.$(date +%Y%m%d_%H%M%S)" || true
          fi

          # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
          echo "Deploying new version..."
          sudo mkdir -p "$APP_DIR"
          sudo cp -r /tmp/deploy/* "$APP_DIR/"
          sudo chown -R ec2-user:ec2-user "$APP_DIR"

          # æ¨©é™è¨­å®š
          chmod +x "$APP_DIR/server.js" || true

          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
          echo "Starting application..."
          cd "$APP_DIR"

          # PM2ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
          if command -v pm2 &> /dev/null; then
            pm2 delete mokin-recruit || true
            pm2 start server.js --name mokin-recruit
            pm2 save
          else
            # systemdã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹å ´åˆ
            if systemctl is-active --quiet mokin-recruit; then
              sudo systemctl restart mokin-recruit
            else
              # ç›´æ¥å®Ÿè¡Œ
              nohup node server.js > /tmp/app.log 2>&1 &
            fi
          fi

          echo "âœ… Deployment completed successfully!"

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          sleep 5
          if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
            echo "âœ… Application is running"
          else
            echo "âš ï¸  Health check failed - check logs"
          fi
          EOF

          chmod +x deploy/deploy.sh

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åœ§ç¸®
          tar -czf deploy.tar.gz -C deploy .

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            rm -rf /tmp/deploy /tmp/deploy.tar.gz

            # Node.jsç’°å¢ƒç¢ºèª
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
              sudo yum install -y nodejs
            fi

            # PM2ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
              pm2 startup
            fi

      - name: Upload and extract files
        uses: appleboy/scp-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Execute deployment
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            # è§£å‡
            cd /tmp
            tar -xzf deploy.tar.gz -C /tmp/deploy/

            # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
            chmod +x /tmp/deploy/deploy.sh
            /tmp/deploy/deploy.sh

            # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            rm -rf /tmp/deploy /tmp/deploy.tar.gz

      - name: Health check
        run: |
          echo "Waiting for application to start..."
          sleep 10

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          for i in {1..5}; do
            if curl -f http://${{ secrets.EC2_HOST }}:3000/ > /dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          done

          echo "âŒ Health check failed"
          exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Deployment to EC2 successful!"
            echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}:3000"
          else
            echo "âŒ Deployment failed"
          fi