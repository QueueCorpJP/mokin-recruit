# APIã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®ç§»è¡Œãƒ—ãƒ­ã‚»ã‚¹

## æ¦‚è¦
APIãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰Next.js 13+ã®ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åŠ¹ç‡çš„ã«ç§»è¡Œã™ã‚‹ãŸã‚ã®æ¨™æº–ãƒ—ãƒ­ã‚»ã‚¹ã¨æ³¨æ„ç‚¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚ä»Šå›ã®æ±‚äººæ¤œç´¢æ©Ÿèƒ½ã®å¤±æ•—ä½“é¨“ã‚’ã‚‚ã¨ã«ã€ä»–ã®ãƒšãƒ¼ã‚¸ã§ã‚‚åŒæ§˜ã®å¤±æ•—ã‚’é¿ã‘ã‚‹ãŸã‚ã®æ‰‹é †æ›¸ã§ã™ã€‚

## ğŸš€ æ¨™æº–ç§»è¡Œãƒ—ãƒ­ã‚»ã‚¹ï¼ˆä»–ã®ãƒšãƒ¼ã‚¸ç”¨ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º1: äº‹å‰èª¿æŸ»ï¼ˆ1æ™‚é–“ï¼‰

#### 1-1. æ—¢å­˜APIã®ç†è§£
```bash
# å¯¾è±¡APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®š
grep -r "api/" src/app/target-page/
```

- [ ] APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®URLç¢ºèª
- [ ] ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å®šç¾©ç¢ºèª  
- [ ] èªè¨¼ãƒ»èªå¯è¦ä»¶ã®ç¢ºèª
- [ ] ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç‰¹å®š

#### 1-2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
```javascript
// test-schema-{feature}.js ã‚’ä½œæˆ
const { createClient } = require('@supabase/supabase-js');

async function testSchema() {
  const supabase = createClient(url, key);
  
  // 1. åŸºæœ¬çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
  const { data, error } = await supabase
    .from('target_table')
    .select('*')
    .limit(1);
    
  // 2. é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®joinå¯èƒ½æ€§ç¢ºèª
  // 3. å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
}
```

- [ ] ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ æ§‹æˆç¢ºèª
- [ ] å¤–éƒ¨ã‚­ãƒ¼é–¢ä¿‚ã®ç¢ºèªï¼ˆdatabase.md vs å®Ÿéš›ã®DBï¼‰
- [ ] å¿…è¦ãªjoinæ“ä½œã®å®Ÿè¡Œå¯èƒ½æ€§ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿å‹ç¢ºèª

#### 1-3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆã®åˆ†æ
- [ ] Client Componentã¨Server Componentã®åˆ†é›¢ãƒã‚¤ãƒ³ãƒˆç‰¹å®š
- [ ] çŠ¶æ…‹ç®¡ç†ãŒå¿…è¦ãªéƒ¨åˆ†ã®ç‰¹å®š
- [ ] ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ã®ç‰¹å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç­‰ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º2: è¨­è¨ˆãƒ»å®Ÿè£…è¨ˆç”»ï¼ˆ30åˆ†ï¼‰

#### 2-1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
```
page.tsx
â”œâ”€â”€ {Feature}ServerComponent
â”‚   â”œâ”€â”€ åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚   â”œâ”€â”€ URL params â†’ search conditions å¤‰æ›
â”‚   â””â”€â”€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
â””â”€â”€ {Feature}Client
    â”œâ”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
    â”œâ”€â”€ çŠ¶æ…‹ç®¡ç†
    â””â”€â”€ å‹•çš„æ›´æ–°
```

#### 2-2. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆè¨ˆç”»
- [ ] `actions.ts` - ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°
- [ ] `{Feature}ServerComponent.tsx` - ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] `{Feature}Client.tsx` - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] `page.tsx` - ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆä¿®æ­£ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º3: æ®µéšçš„å®Ÿè£…ï¼ˆ2-3æ™‚é–“ï¼‰

#### 3-1. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®ä½œæˆ
```typescript
// actions.ts
'use server'

export async function get{Feature}Data(params: Params) {
  try {
    const supabase = getSupabaseAdminClient();
    
    // ã¾ãšã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã§ãƒ†ã‚¹ãƒˆ
    const { data, error } = await supabase
      .from('main_table')
      .select('*')
      .limit(5);
      
    if (error) throw error;
    
    return { success: true, data };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

**âš ï¸ é‡è¦**: æœ€åˆã¯è¤‡é›‘ãªjoinã‚’é¿ã‘ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã‹ã‚‰é–‹å§‹

#### 3-2. ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ
```typescript
// {Feature}ServerComponent.tsx
export default async function FeatureServerComponent({ searchParams }) {
  // 1. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ
  const conditions = parseSearchParams(searchParams);
  
  // 2. ãƒ‡ãƒ¼ã‚¿å–å¾—
  const response = await getFeatureData(conditions);
  
  // 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  if (!response.success) {
    return <ErrorComponent message={response.error} />;
  }
  
  // 4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã™
  return (
    <FeatureClient 
      initialData={response.data}
      initialConditions={conditions}
    />
  );
}
```

#### 3-3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ
```typescript
// {Feature}Client.tsx
'use client'

export default function FeatureClient({ initialData, initialConditions }) {
  const [data, setData] = useState(initialData);
  const [conditions, setConditions] = useState(initialConditions);
  
  // å¿…é ˆ: propsã®å¤‰æ›´ã‚’ç›£è¦–
  useEffect(() => {
    setData(initialData);
    setConditions(initialConditions);
  }, [initialData, initialConditions]);
  
  return (
    // UIå®Ÿè£…
  );
}
```

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ï¼ˆ1æ™‚é–“ï¼‰

#### 4-1. æ®µéšçš„ãƒ†ã‚¹ãƒˆ
```bash
# 1. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ†ã‚¹ãƒˆ
node test-{feature}-data.js

# 2. ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèª

# 3. çŠ¶æ…‹åŒæœŸã®ãƒ†ã‚¹ãƒˆ
# ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç­‰ã®å‹•ä½œç¢ºèª
```

#### 4-2. å…±é€šã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯¾å‡¦æ³•

**âŒ ã‚¨ãƒ©ãƒ¼1: "Could not find a relationship"**
```typescript
// å¯¾å‡¦: join ã‚’åˆ†é›¢
// æ‚ªã„ä¾‹
.select('*, related_table!inner(*)')

// è‰¯ã„ä¾‹
const mainData = await supabase.from('main_table').select('*');
const relatedData = await supabase.from('related_table').select('*').in('id', ids);
```

**âŒ ã‚¨ãƒ©ãƒ¼2: "TypeError: fetch failed"**
- åŸå› : ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§è‡ªåˆ†ã®APIã‚’å‘¼ã³å‡ºã—
- å¯¾å‡¦: ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã«å¤‰æ›´

**âŒ ã‚¨ãƒ©ãƒ¼3: çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œãªã„**
```typescript
// å¯¾å‡¦: useEffectã§çŠ¶æ…‹åŒæœŸ
useEffect(() => {
  setState(initialData);
}, [initialData]);
```

## ğŸ¯ æˆåŠŸã®ãŸã‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ

### 1. **Always Schema First**
- å®Ÿè£…å‰ã«å¿…ãšãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’ç¢ºèª
- æ¨æ¸¬ã§joinã›ãšã€å¿…ãšãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ¤œè¨¼

### 2. **Small Steps, Big Wins**
- æœ€åˆã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã‹ã‚‰é–‹å§‹
- æ®µéšçš„ã«æ©Ÿèƒ½ã‚’è¿½åŠ 
- å„æ®µéšã§ãƒ†ã‚¹ãƒˆãƒ»ç¢ºèª

### 3. **State Sync is Critical**
- ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®çŠ¶æ…‹åŒæœŸã‚’å¿…ãšå®Ÿè£…
- `useEffect`ã§propsã®å¤‰æ›´ã‚’ç›£è¦–

### 4. **Test Early, Test Often**
- å„ãƒ•ã‚§ãƒ¼ã‚ºã§ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¦ãƒ‡ãƒãƒƒã‚°

## ğŸ“‹ ç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæ±ç”¨ç‰ˆï¼‰

### äº‹å‰æº–å‚™
- [ ] å¯¾è±¡APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç‰¹å®š
- [ ] ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¹ã‚­ãƒ¼ãƒã®ç¢ºèª
- [ ] å¤–éƒ¨ã‚­ãƒ¼é–¢ä¿‚ã®æ¤œè¨¼
- [ ] èªè¨¼ãƒ»èªå¯è¦ä»¶ã®ç¢ºèª

### å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- [ ] actions.ts ã§ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
- [ ] ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] çŠ¶æ…‹åŒæœŸã®å®Ÿè£…

### æ¤œè¨¼
- [ ] åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã®å‹•ä½œç¢ºèª
- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»æ¤œç´¢ã®å‹•ä½œç¢ºèª
- [ ] ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### å®Œäº†
- [ ] æ—§APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‰Šé™¤
- [ ] ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

## â° æƒ³å®šæ™‚é–“é…åˆ†
- **ãƒ•ã‚§ãƒ¼ã‚º1 (èª¿æŸ»)**: 1æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º2 (è¨­è¨ˆ)**: 30åˆ†  
- **ãƒ•ã‚§ãƒ¼ã‚º3 (å®Ÿè£…)**: 2-3æ™‚é–“
- **ãƒ•ã‚§ãƒ¼ã‚º4 (ãƒ†ã‚¹ãƒˆ)**: 1æ™‚é–“

**åˆè¨ˆ**: 4.5-5.5æ™‚é–“/ãƒšãƒ¼ã‚¸

## ğŸ“š ä»Šå›ã®äº‹ä¾‹ã‹ã‚‰å­¦ã‚“ã å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³

### âŒ å¤±æ•—1: ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®fetchä½¿ç”¨
```typescript
// é–“é•ã„ - ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰è‡ªåˆ†ã®APIã‚’å‘¼ã¶
const response = await fetch('/api/jobs/search');
// ã‚¨ãƒ©ãƒ¼: TypeError: fetch failed
```

### âŒ å¤±æ•—2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ç†è§£ä¸è¶³
```typescript
// é–“é•ã„ - å­˜åœ¨ã—ãªã„é–¢ä¿‚ã‚’join
company_accounts!inner(id, company_name)
// ã‚¨ãƒ©ãƒ¼: Could not find a relationship
```

### âŒ å¤±æ•—3: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®éåŒæœŸå•é¡Œ
```typescript
// å•é¡Œ: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ–°ã—ã„propsã¨åŒæœŸã•ã‚Œã¦ã„ãªã„
// è§£æ±º: useEffectã§çŠ¶æ…‹åŒæœŸ
useEffect(() => {
  setPagination(initialPagination);
}, [initialPagination]);
```

## ğŸ‰ æˆåŠŸä¾‹
- âœ… 45ä»¶ã®æ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸å–å¾—
- âœ… 5ãƒšãƒ¼ã‚¸ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œ
- âœ… å®Ÿéš›ã®ä¼æ¥­åè¡¨ç¤º
- âœ… æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
- âœ… APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®æ”¹å–„

ã“ã®æ‰‹é †ã«å¾“ã†ã“ã¨ã§ã€ä»Šå›ã®ã‚ˆã†ãªè©¦è¡ŒéŒ¯èª¤ã‚’é¿ã‘ã€åŠ¹ç‡çš„ã«APIã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ç§»è¡Œã§ãã¾ã™ã€‚