# 遷移速度ボトルネック分析レポート

## 概要
Mokin Recruitプロジェクト全体のコードを詳細に分析し、遷移速度が遅い原因となっているボトルネックを特定しました。

## 主要なボトルネック

### 1. 認証状態の確認処理（最重要）

#### 問題点
- **AuthInitializer**（`client/src/components/AuthInitializer.tsx`）が全ページで実行
- ページ遷移時に毎回`fetchUserSession`を呼び出し、`/api/auth/session`にリクエスト
- セッションAPIでは毎回データベースアクセスが発生：
  - candidatesテーブルの検索
  - company_usersテーブルの検索

#### 該当コード
```typescript
// AuthInitializer.tsx:19-25
if (!hasInitialized.current) {
  hasInitialized.current = true;
  const { fetchUserSession, initialized } = authStore.getState();
  if (!initialized) {
    fetchUserSession();
  }
}

// api/auth/session/route.ts:56-85
// データベースから追加情報を取得（毎回実行）
const { data: candidate } = await supabase
  .from('candidates')
  .select('id, last_name, first_name, email')
  .eq('email', sessionInfo!.user.email)
  .single();
```

#### 影響
- 各ページ遷移で200-500msの遅延
- 認証済みユーザーでも毎回DBアクセス

### 2. ログイン処理の重複処理

#### 問題点
- **AuthController**（`client/src/lib/server/controllers/AuthController.ts`）のloginメソッドが過度に複雑
- 直列的な処理フロー：
  1. バリデーション
  2. 候補者の独自認証試行
  3. Supabase認証
  4. ユーザー検索（候補者→企業の順）
  5. メタデータ更新
  6. last_login_at更新

#### 該当コード
```typescript
// AuthController.ts:249-333
// 候補者の場合、まず独自認証を試行
if (userType === 'candidate') {
  const candidate = await this.candidateRepository.findByEmail(email);
  // パスワード検証、セッション作成など
}

// その後Supabase認証
if (useSupabaseAuth) {
  authResult = await signInWithSupabase(email, password);
}

// さらにユーザー情報の再取得
// 384-504行目で重複したDB検索
```

#### 影響
- ログイン処理で1-2秒の遅延
- 同じユーザー情報を複数回取得

### 3. Server Componentsでの重い処理

#### 問題点
- **CandidateSearchServerComponent**で複数の同期的なDB操作：
  - 求人データの取得
  - お気に入り状態の取得
  - 企業情報の取得

#### 該当コード
```typescript
// CandidateSearchServerComponent.tsx:42-66
const jobSearchResponse = await getJobSearchData(searchConditions);
// ...
const favoriteResponse = await getFavoriteStatusServer(jobIds);

// actions.ts:144-147
// 並列実行されているが、企業情報は別途取得
const [countResult, dataResult] = await Promise.all([
  countQuery,
  dataQuery
]);
// 166-180行目で企業情報を追加取得
```

#### 影響
- 初回レンダリングで500ms-1秒の遅延

### 4. フォント最適化の問題

#### 問題点
- **Noto Sans JP**のpreloadがfalseに設定
- 日本語フォントの読み込みが遅延

#### 該当コード
```typescript
// layout.tsx:25-31
const notoSansJP = Noto_Sans_JP({
  subsets: ['latin'],
  display: 'swap',
  preload: false, // ← 問題箇所
  variable: '--font-noto-sans-jp',
  weight: ['400', '500', '700'],
});
```

#### 影響
- フォントの読み込み遅延によるレイアウトシフト
- 初回表示で200-300msの遅延

### 5. 画像最適化の不足

#### 問題点
- publicディレクトリに多数の未最適化画像
- 一部でNext.js Imageコンポーネント未使用
- background-imageでの画像使用

#### 該当箇所
- `/public/images/`に30以上の画像ファイル
- `candidate-auth-background.tsx`でbackground-image使用

#### 影響
- 画像ダウンロードによる遅延
- LCPの悪化

### 6. バンドル最適化の不足

#### 問題点
- **experimental.optimizePackageImports**が一部のパッケージのみ
- splitChunksは設定されているが、さらなる最適化が可能

#### 該当コード
```typescript
// next.config.ts:23-27
optimizePackageImports: [
  'lucide-react',
  '@radix-ui/react-slot',
  '@radix-ui/react-label',
], // 他の大きなパッケージが含まれていない
```

#### 影響
- 初回ロードのバンドルサイズが大きい

## 改善提案（優先度順）

### 1. 認証状態管理の最適化
- セッション情報のキャッシング実装
- 認証状態の再検証を必要時のみに制限
- クライアントサイドでの状態保持強化

### 2. ログイン処理の効率化
- 並列処理の活用
- 重複したDB検索の削除
- ユーザータイプ別の処理を早期分岐

### 3. Server Componentsの最適化
- Partial Prerenderingの活用
- データフェッチの並列化
- React Suspenseの適切な使用

### 4. フォント最適化
- Noto Sans JPのpreloadを有効化
- フォントウェイトの絞り込み
- font-displayの調整

### 5. 画像最適化
- 全画像をNext.js Imageコンポーネントで表示
- 画像の事前最適化（WebP形式への変換）
- 適切なサイズでの配信

### 6. バンドル最適化
- optimizePackageImportsの拡充
- 動的インポートの活用
- 不要な依存関係の削除

## まとめ
最も大きな影響を与えているのは、**認証状態の確認処理**と**ログイン処理の重複**です。これらを優先的に改善することで、体感速度の大幅な向上が期待できます。